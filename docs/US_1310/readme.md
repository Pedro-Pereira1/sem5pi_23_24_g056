# US 1310 - As the solution architect, I pretend that every service in the backend are authenticated

## 1. Context

* First time that this task is developed.

## 2. Requirements

Being able to send a request to a backend service and it has to be authenticated

**Dependencies:**

**US 10** As an administrator, I pretend to register a system user specifying their permissions

**US 20** As a potencial system user, I pretend to register myself into the system

## 3. Analysis

Every time there is a request to a backend service, this request needs to be validated
in order to check if the request was made by a registered system user

## 4. Design

To implement this use case, we will implement a service which will take the received token by the routing
component and passed down to a controller and will verify if it is a valid token. These tokens will be
generated by the authentication component every time the user logins into the system

### 4.1. Realization

### Level1

#### LogicalView

![LogicalView](Diagrams/Level1/LogicalView.svg)

#### SceneryView

![SceneryView](Diagrams/Level1/SceneryView.svg)

#### ProcessView

![ProcessView](Diagrams/Level1/ProcessView.svg)

### Level2

#### LogicalView

![LogicalView](Diagrams/Level2/LogicalView.svg)

#### ImplementationView

![ImplementationView](Diagrams/Level2/ImplementationView.svg)

#### PhysicalView

![PhysicalView](Diagrams/Level2/PhysicalView.svg)

#### ProcessView

![ProcessView](Diagrams/Level2/ProcessView.svg)

### Level3

#### LogicalView

![LogicalView](Diagrams/Level3/LogicalView.svg)

#### ImplementationView

![ImplementationView](Diagrams/Level3/ImplementationView.svg)

#### ProcessView

![ProcessView](Diagrams/Level3/ProcessView.svg)

### 4.2. Applied Patterns

* Controller
* Service

### 4.3. Tests

```typescript
describe('Valid Token Test', () => {

    beforeEach(() => {
        Container.reset();

        let authService = require('../../src/services/auth/AuthService').default
        Container.set('authService', new authService())
    })


    it('1. should return true if token is valid', () => {
        var authService = Container.get('authService') as IAuthService
        var token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjEyMTExNTFAaXNlcC5pcHAucHQiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJDYW1wdXNNYW5hZ2VyIiwiZXhwIjoxNzAzNzAzMzI5fQ.Mgpp88Xi7CjX1v-AOMZOCZLHl3GviHv6JU5Az4zafgY"  
        let req: Partial<Request> = {
            headers: {
                authorization: `Bearer ${token}`
            }
        }
        authService.validateToken(req as Request);
        //@ts-ignore
        assert.equal(req.userId, "1211151@isep.ipp.pt");
        //@ts-ignore
        assert.equal(req.userRole, "CampusManager");
    })

    it('2. should return false if token is invalid', () => {
        var authService = Container.get('authService') as IAuthService
        var token = "invalidToken"  
        let req: Partial<Request> = {
            headers: {
                authorization: `Bearer ${token}`
            }
        }
        var result: boolean = authService.validateToken(req as Request);
        assert.equal(result, false);
    })

    it('3. should return false if token is not present', () => {
        var authService = Container.get('authService') as IAuthService
        let req: Partial<Request> = {
            headers: {}
        }
        var result: boolean = authService.validateToken(req as Request);
        assert.equal(result, false);
    })

    it('4. should return false if token was made with another key', () => {
        var authService = Container.get('authService') as IAuthService
        var token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjEyMTEwODlAaXNlcC5pcHAucHQiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJUYXNrTWFuYWdlciIsImV4cCI6MTcwMzcwODM0NH0.t5IbnvfzKg_rOV4p-kc3ponKwmVPTSYF4bqa2V1uitc"  
        let req: Partial<Request> = {
            headers: {
                authorization: `Bearer ${token}`
            }
        }
        var result: boolean = authService.validateToken(req as Request);
        assert.equal(result, false);
    })
})
```

## 5. Implementation

```ts
    public validateToken(req: Request): boolean {
        var auth = req.headers['authorization']
        if (!auth) {
            //return res.status(401)
            return false
        }
        var token = auth.split(' ')[1];
        var isValid: boolean = false
        if (token) {
            jwt.verify(token, "u2mUMiNxgfIbfXIOhOFskAI8o6doVRCH", (err, decoded) => {
                if (err) {
                    console.log("error")
                    //return res.status(500)
                    return false
                }
                // @ts-ignore
                req.userId = decoded['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier']
                // @ts-ignore
                req.userRole = decoded['http://schemas.microsoft.com/ws/2008/06/identity/claims/role']
                isValid = true
            })
        }
        return isValid
    }
```

## 6. Integration/Demonstration

To ensure that this use case is properly working you need to receive a jwt received by the auth module
and send it inside an http header, if it is a genuine token then the service that you called will execute.

## 7. Observations

No observations.
